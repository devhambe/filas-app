<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="icon" href="favicon.ico">
    <title>Dashboard</title>
</head>

<body>
    <div class="d-flex wrapper">

        <%- include ('includes/sidebar') %>

        <div class="container-fluid">
            <div class="content">
                <div class="fila row">
                    <div class="fila-header col-1">
                        A
                    </div>
                    <div class="fila-desc col-2">
                        Fila de espera <br>
                        <b>Atendimento Geral</b>
                    </div>
                    <div class="fila-espera col-2">
                        <p>Em espera</p>
                        <i class="fas fa-users"></i> <span id="qtd-A">0</span>
                    </div>
                    <div class="fila-next col-5">
                        <p>Próxima senha</p>
                        <span class="next-A">...</span>
                    </div>
                    <div class="fila-call col-1">
                        <button class="btn btn-custom btn-chamar" data-toggle="modal" data-target="#senha-modal"
                            data-backdrop="static" data-keyboard="false" data-fila="A">CHAMAR</button>
                    </div>
                </div>
                <div class="fila row">
                    <div class="fila-header col-1">
                        B
                    </div>
                    <div class="fila-desc col-2">
                        Fila de espera <br>
                        <b>Atendimento Geral</b>
                        <!-- TODO ideias -->
                    </div>
                    <div class="fila-espera col-2">
                        <p>Em espera</p>
                        <i class="fas fa-users"></i> <span id="qtd-B">0</span>
                    </div>
                    <div class="fila-next col-5">
                        <p>Próxima senha</p>
                        <span class="next-B">...</span>
                    </div>
                    <div class="fila-call col-1">
                        <button class="btn btn-custom btn-chamar" data-toggle="modal" data-target="#senha-modal"
                            data-backdrop="static" data-keyboard="false" data-fila="B">CHAMAR</button>
                    </div>
                </div>
                <div class="fila row">
                    <div class="fila-header col-1">
                        C
                    </div>
                    <div class="fila-desc col-2">
                        Fila de espera <br>
                        <b>Atendimento Geral</b>
                    </div>
                    <div class="fila-espera col-2">
                        <p>Em espera</p>
                        <i class="fas fa-users"></i> <span id="qtd-C">0</span>
                    </div>
                    <div class="fila-next col-5">
                        <p>Próxima senha</p>
                        <span class="next-C">...</span>
                    </div>
                    <div class="fila-call col-1">
                        <button class="btn btn-custom btn-chamar" data-toggle="modal" data-target="#senha-modal"
                            data-backdrop="static" data-keyboard="false" data-fila="C">CHAMAR</button>
                    </div>
                </div>
                <div class="fila row">
                    <div class="fila-header col-1">
                        D
                    </div>
                    <div class="fila-desc col-2">
                        Fila de espera <br>
                        <b>Atendimento Geral</b>
                    </div>
                    <div class="fila-espera col-2">
                        <p>Em espera</p>
                        <i class="fas fa-users"></i> <span id="qtd-D">0</span>
                    </div>
                    <div class="fila-next col-5">
                        <p>Próxima senha</p>
                        <span class="next-D">...</span>
                    </div>
                    <div class="fila-call col-1">
                        <button class="btn btn-custom btn-chamar" data-toggle="modal" data-target="#senha-modal"
                            data-backdrop="static" data-keyboard="false" data-fila="D">CHAMAR</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Senha -->
        <div class="modal fade" id="senha-modal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Dados do cliente:</h5>
                        <h5 class="modal-senha"></h5>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="form-cliente">
                            <div class="form-group row">
                                <div class="col-md-6">
                                    <label for="primeiro_nome">Primeiro Nome</label>
                                    <input type="text" class="form-control" name="primeiro_nome">
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-md-6">
                                    <label for="ultimo_nome">Último Nome</label>
                                    <input type="text" class="form-control" name="ultimo_nome">
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-md-9">
                                    <label for="morada">Morada</label>
                                    <input type="text" class="form-control" name="morada">
                                </div>
                                <div class="col-md-3">
                                    <label for="cod_postal">Código Postal</label>
                                    <input type="text" class="form-control" name="cod_postal">
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-md-6">
                                    <label for="cidade">Cidade</label>
                                    <input type="text" class="form-control" name="cidade">
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-md-6">
                                    <label for="concelho">Concelho</label>
                                    <input type="text" class="form-control" name="concelho">
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-md-6">
                                    <label for="email">Email</label>
                                    <input type="email" class="form-control" name="email">
                                </div>
                                <div class="col-md-4">
                                    <label for="telefone">Telefone</label>
                                    <input type="text" class="form-control" name="telefone">
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-md-4">

                                </div>
                            </div>
                    </div>
                    <div class="modal-footer">
                        <div class="dropdown">
                            <button class="btn btn-custom dropdown-toggle" type="button" data-toggle="dropdown">
                                Transferir para outra lista
                            </button>
                            <div class="dropdown-menu">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-custom" data-dismiss="modal" id="atender-senha">Marcar
                            como atendido</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script src="/js/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="https://kit.fontawesome.com/a747b443e5.js" crossorigin="anonymous"></script>
<script src="/socket.io/socket.io.js"></script>

<script>
    const socket = io('http://localhost:3000');

    socket.emit('dashboard');

    socket.on('dashboard-filas', (data) => {
        const qtd = ['#qtd-A', '#qtd-B', '#qtd-C', '#qtd-D'];
        const next = ['.next-A', '.next-B', '.next-C', '.next-D'];
        populateUsers(qtd, data.users);
        populateSenhas(next, data.senhas);
        // TODO tempo de espera
        // TODO botão chamar disabled
    });

    $('#senha-modal').on('show.bs.modal', function (e) {
        socket.emit('dashboard');
        const button = $(e.relatedTarget);
        const fila = button.data('fila');
        const modal = $(this);
        modal.attr('data-fila', fila)
        modal.find('.modal-senha').attr('class', `modal-title next-${fila}`);
        let filas = ['A', 'B', 'C', 'D'];
        filas.splice(filas.indexOf(fila), 1);
        modal.find('.dropdown-menu').empty();
        for (let i = 0; i < filas.length; i++) {
            modal.find('.dropdown-menu').append(`<a class="dropdown-item trocar-fila" href="#" data-fila_atual=${fila} data-fila_nova="${filas[i]}"> Fila ${filas[i]}</a>`);
        }
    });

    $(document).on('click', '.trocar-fila', function () {
        const filaAtual = $(this).data('fila_atual');
        const filaNova = $(this).data('fila_nova');
        socket.emit('trocar-fila', filaAtual, filaNova);
        $('#senha-modal').modal('hide');
    });

    // Ao carregar no botão de chamar
    $('.btn-chamar').click(function () {
        const fila = $(this).data('fila');
        const balcao = $('.balcao-atual').data('id');
        socket.emit('chamar-senha', fila, balcao);
    });

    // Ao marcar o cliente como 'atendido'
    $(document).on('click', '#atender-senha', function (e) {
        e.preventDefault();
        const fila = $('#senha-modal').attr('data-fila');
        const $form = $('#form-cliente');
        const data = serializeToJson($form);
        // TODO registar na bd?
        $('#form-cliente').trigger("reset");
        socket.emit('senha-atendida', fila);
    });

    mostrarFuncao('<%= nivel %>', '<%= id %>');

</script>

</html>